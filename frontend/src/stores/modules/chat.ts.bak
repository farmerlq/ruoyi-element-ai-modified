import type { ChatMessageVo } from '@/api/chat/types';
import { defineStore } from 'pinia';
import { getChatList } from '@/api/chat';
import { useUserStore } from './user';

export const useChatStore = defineStore('chat', () => {
  const userStore = useUserStore();

  // 用户头像
  const avatar = computed(() => {
    const userInfo = userStore.userInfo;
    return userInfo?.avatar || 'https://avatars.githubusercontent.com/u/76239030?v=4';
  });

  // 是否开启深度思考
  const isDeepThinking = ref<boolean>(false);

  const setDeepThinking = (value: boolean) => {
    isDeepThinking.value = value;
  };

  // 会议ID对应-聊天记录 map对象
  const chatMap = ref<Record<string, ChatMessageVo[]>>({});

  const setChatMap = (id: string, data: ChatMessageVo[]) => {
    chatMap.value[id] = data?.map((item: ChatMessageVo) => {
      const isUser = item.role === 'user';
      const thinkContent = extractThkContent(item.content as string);
      return {
        ...item,
        key: item.id,
        placement: isUser ? 'end' : 'start',
        isMarkdown: !isUser,
        // variant: 'shadow',
        // shape: 'corner',
        avatar: isUser
          ? avatar
          : 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png',
        avatarSize: '32px',
        typing: false,
        reasoning_content: thinkContent,
        thinkingStatus: 'end',
        content: extractThkContentAfter(item.content as string),
        thinkCollapse: false,
      };
    });
  };

  // 获取当前会话的聊天记录
  const requestChatList = async (sessionId: string) => {
    // 如果没有 token 则不查询聊天记录
    if (!userStore.token) {
      return;
    }
    try {
      const res = await getChatList({
        sessionId,
        userId: userStore.userInfo?.userId as number,
      });

      // 处理API响应对象，从res.data中获取实际数据
      let chatData: ChatMessageVo[] = [];
      if (res && typeof res === 'object' && 'data' in res) {
        const responseData = res.data;
        if (Array.isArray(responseData)) {
          chatData = responseData;
        } else if (
          responseData &&
          typeof responseData === 'object' &&
          'rows' in responseData &&
          Array.isArray((responseData as any).rows)
        ) {
          chatData = (responseData as any).rows;
        }
      } else if (Array.isArray(res)) {
        chatData = res;
      }

      // 在前端按sessionId过滤消息
      const filteredChatData = chatData.filter((message: ChatMessageVo) => 
        String(message.sessionId) === sessionId,
      );

      if (filteredChatData.length > 0) {
        setChatMap(sessionId, filteredChatData);
      }
    } catch (error) {
      console.error('getChatList:', error);
    }
  };

  // 对思考中的内容回显做处理
  function extractThkContent(content: string) {
    const regex = /
    const matchResult = content.match(regex);
    // 把这些内容从 content 中移除
    content = content.replace(regex, '');
    return matchResult?.[1] ?? '';
  }

  // 如果有 <think> 标签，则把 </think> 之后的内容从 content 中返回
  function extractThkContentAfter(content: string) {
    if (!content.includes('<think>')) {
      return content;
    }
    const regex = /<\/think>(.*)/s;
    const matchResult = content.match(regex);
    // 把这些内容从 content 中移除
    content = content.replace(regex, '');
    return matchResult?.[1] ?? '';
  }